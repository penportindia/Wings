<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student list</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* ========================================================= */
        /* FINAL ADVANCED UI & FULL-WIDTH TABLE STYLES (CLEANED) */
        /* ========================================================= */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --bg-dark: #f0f2f5;
            --card-bg: #ffffff;
            --text-dark: #212529;
            --border-color: #e9ecef;
            --input-bg: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        html,body{height:100%;}
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            width: 98%;
            max-width: none;
            margin: 15px auto;
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .main-header-controls {
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .title-and-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .title-and-stats h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .title-and-stats h1 i { margin-right: 15px; color: var(--info-color); }

        .summary-stats { display: flex; gap: 20px; }
        .stat-item { display:flex; align-items:center; font-weight:600; padding:5px 10px; border-radius:6px; }
        .stat-item i { font-size:1.1rem; margin-right:8px; color:var(--success-color); }
        .stat-item.filtered i { color: var(--primary-color); }
        .stat-item span { color:var(--text-dark); font-weight:700; font-size:1.1rem; }

        .control-bar {
            display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; background:var(--input-bg); border-radius:8px;
        }
        .filter-group { display:flex; gap:10px; flex-grow:1; align-items:center; }
        .action-group { display:flex; gap:10px; align-items:center; }

        .filter-input, .filter-select {
            padding:9px 12px; border:1px solid #ced4da; border-radius:6px; font-size:0.9rem; background:#fff; min-width:120px;
        }
        .filter-input { min-width:280px; }

        .btn { padding:9px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all .2s; display:flex; align-items:center; gap:5px; font-size:0.9rem; }
        .btn-clear{ background:var(--secondary-color); color:#fff; }
        .btn-clear:hover{ background:#5a6268; }
        .btn-excel{ background:var(--success-color); color:#fff; }
        .btn-excel:hover{ background:#1e7e34; }
        .btn-settings{ background:var(--info-color); color:#fff; padding:9px 10px; font-size:1rem; width:40px; justify-content:center; position:relative; }
        .btn-settings:hover{ background:#117a8b; }
        .btn-filter-settings { background:var(--danger-color); color:#fff; }
        .btn-filter-settings:hover { background:#a30018; }

        .column-toggler{ position:relative; display:inline-block; }
        #columnTogglerContent{ display:none; position:absolute; top:100%; right:0; z-index:100; background:var(--card-bg); min-width:220px; max-height:320px; overflow:auto; border:1px solid var(--border-color); border-radius:8px; box-shadow:0 8px 16px rgba(0,0,0,.15); padding:10px; margin-top:5px; }
        #columnTogglerContent label{ display:block; padding:6px 5px; cursor:pointer; font-size:.9rem; border-radius:4px; transition:background-color .1s; white-space:nowrap; }
        #columnTogglerContent label:hover{ background:var(--input-bg); }
        #columnTogglerContent input[type='checkbox']{ margin-right:8px; accent-color:var(--primary-color); }

        .table-responsive{ overflow-x:auto; width:100%; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
        #studentTable{ width:100%; border-collapse:separate; border-spacing:0; min-width:1000px; }
        #studentTable thead th{ background:var(--primary-color); color:#fff; padding:12px 18px; font-size:.85rem; position:sticky; top:0; z-index:50; }
        #studentTable tbody tr{ border-bottom:1px solid var(--border-color); }
        #studentTable tbody tr:hover{ background:#e6f0ff; }
        #studentTable th,#studentTable td{ padding:10px 18px; text-align:left; white-space:nowrap; font-size:.9rem; }
        .action-btn{ padding:6px 10px; font-size:.8rem; }
        .btn-edit{ background:var(--success-color); color:#fff; border-radius:6px; border:none; }

        .pagination-controls{ margin-top:20px; display:flex; gap:12px; align-items:center; }
        
        /* Styles for Page Number Input */
        .pagination-info-group {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }
        #pageNumberInput {
            width: 50px;
            text-align: center;
            margin: 0 5px;
            padding: 6px 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
        }

        .loading-row{ text-align:center; padding:18px; color:var(--secondary-color); }

        /* ========================================================= */
        /* MODAL STYLES FOR ADVANCED FILTER */
        /* ========================================================= */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(3px);
            padding-top: 50px;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto; 
            padding: 30px;
            border-radius: 12px;
            width: 90%; 
            max-width: 500px; /* Smaller Modal for simpler filters */
            box-shadow: var(--card-shadow);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        @keyframes animatetop {
            from {top:-300px; opacity:0} 
            to {top:0; opacity:1}
        }

        .modal-header {
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--danger-color);
            font-size: 1.5rem;
        }

        .close-btn {
            color: var(--secondary-color);
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--danger-color);
            text-decoration: none;
            cursor: pointer;
        }

        #filterCriteria {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px; 
        }
        .filter-row {
            display: grid;
            grid-template-columns: 2fr 3fr auto; 
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 6px;
        }
        .filter-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-row button {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.2rem;
            width: 30px;
        }
        .filter-actions {
            margin-top: 20px;
            display: flex;
            /* Changed to space-between to accommodate the new button */
            justify-content: space-between; 
            gap: 10px;
        }
        /* Style for the new Download button inside the modal */
        .btn-modal-download {
            background-color: var(--success-color);
            color: white;
            font-size: 0.9rem;
        }
        .btn-modal-download:hover {
             background-color: #1e7e34;
        }

        @media (max-width:1200px){ .control-bar{ flex-wrap:wrap; } .filter-group{ flex-wrap:wrap; width:100%; margin-bottom:10px; } .filter-input{ flex-grow:1; min-width:unset; } .title-and-stats{ flex-direction:column; align-items:flex-start; } .summary-stats{ margin-top:10px; flex-wrap:wrap; gap:15px; } }
    </style>
</head>
<body>

    <div class="container" role="main">

        <div class="main-header-controls">
            <div class="title-and-stats">
                <h1><i class="fas fa-graduation-cap" aria-hidden="true"></i> Student list</h1>
                <div class="summary-stats" aria-live="polite">
                    <div class="stat-item" title="Total Students in Database">
                        <i class="fas fa-database" aria-hidden="true"></i>
                        <span id="totalCount">0</span>
                    </div>
                    <div class="stat-item filtered" title="Filtered Records Count">
                        <i class="fas fa-filter" aria-hidden="true"></i>
                        <span id="displayCount">0</span>
                    </div>
                </div>
            </div>

            <div class="control-bar" role="region" aria-label="Table controls">
                <div class="filter-group">
                    <input type="text" id="searchFilter" placeholder="Search (Folio, Name, Father, Mother, Phone)..." class="filter-input" aria-label="Search records">
                    <select id="classFilter" class="filter-select" aria-label="Filter by class"><option value="">All Classes</option></select>
                    <select id="sectionFilter" class="filter-select" aria-label="Filter by section"><option value="">All Sections</option></select>
                    <button id="resetFilters" class="btn btn-clear" title="Reset filters" aria-label="Reset filters"><i class="fas fa-undo" aria-hidden="true"></i> Reset</button>
                </div>

                <div class="action-group">
                    <button id="downloadExcelBtn" class="btn btn-excel" title="Download CSV (Current View)" aria-label="Download CSV"><i class="fas fa-file-excel" aria-hidden="true"></i> Download</button>

                    <button id="openAdvancedFilterBtn" class="btn btn-filter-settings" title="Advanced Filters" aria-label="Open advanced filter settings"><i class="fas fa-sliders" aria-hidden="true"></i> Filter</button>

                    <div class="column-toggler" aria-haspopup="true">
                        <button id="toggleColumnsBtn" class="btn btn-settings" title="Column Settings" aria-expanded="false"><i class="fas fa-cog" aria-hidden="true"></i></button>
                        <div id="columnTogglerContent" class="column-toggler-content" role="menu" aria-hidden="true"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive" aria-live="polite">
            <table id="studentTable">
                <thead>
                    <tr id="tableHeaderRow"></tr>
                </thead>
                <tbody id="studentTableBody">
                    <tr><td colspan="6" class="loading-row"><i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Initializing data...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="noDataMessage" style="display:none; text-align:center; margin-top:25px; font-size:1.1rem; color:var(--danger-color);">
            <i class="fas fa-exclamation-circle" aria-hidden="true"></i> No records found matching the current filters.
        </div>

        <div class="pagination-controls">
            <button id="prevPageBtn" disabled class="btn" aria-label="Previous page"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev 100</button>
            
            <div class="pagination-info-group">
                Page
                <input type="number" id="pageNumberInput" value="1" min="1" aria-label="Current page number">
                of <span id="totalPages">1</span>
            </div>
            
            <button id="nextPageBtn" disabled class="btn" aria-label="Next page">Next 100 <i class="fas fa-arrow-right" aria-hidden="true"></i></button>
        </div>
    </div>

    <div id="advancedFilterModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-filter"></i> Column Value Filters</h2>
                <span class="close-btn" id="closeAdvancedFilterBtn">&times;</span>
            </div>
            <div id="filterCriteria">
                </div>
            <div class="filter-actions">
                <button id="addFilterBtn" class="btn btn-info"><i class="fas fa-plus"></i> Add Filter</button>
                
                <div style="display: flex; gap: 10px;">
                    <button id="downloadFilteredBtn" class="btn btn-modal-download" title="Apply filters and download data" aria-label="Apply filters and download data"><i class="fas fa-file-download"></i> Download</button>

                    <button id="applyFiltersBtn" class="btn btn-danger"><i class="fas fa-check"></i> Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ========================================================= */
        /* JAVASCRIPT LOGIC (UPDATED FOR SIMPLE DROPDOWN FILTERING) */
        /* ========================================================= */

        // FIREBASE CONFIGURATION (kept as provided)
        const firebaseConfig = {
            apiKey: "AIzaSyDCGsnpr6SVf7rbSnRi2ipt5suZD99B2u4",
            authDomain: "student-database-1882d.firebaseapp.com",
            databaseURL: "https://student-database-1882d-default-rtdb.firebaseio.com",
            projectId: "student-database-1882d",
            storageBucket: "student-database-1882d.firebasestorage.app",
            messagingSenderId: "420379838808",
            appId: "1:420379838808:web:bb4206ea2fed40f3907d2d",
            measurementId: "G-MY77MRJJTM"
        };

        // initialize firebase safely
        let database = null;
        if (typeof firebase !== 'undefined') {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (err) {
                console.warn('Firebase init failed or already initialized:', err);
            }
        } else {
            console.warn('Firebase SDK not loaded');
        }

        const STUDENTS_NODE = 'students';

        // Globals
        let allStudentsData = [];
        let filteredStudentsData = [];
        const RECORDS_PER_PAGE = 100;
        let currentPage = 1;
        let uniqueFilters = { classes: new Set(), sections: new Set() };
        let currentAdvancedFilters = []; 
        let columnUniqueValues = {}; 

        const allColumns = [
            { key: 'folio', label: 'Folio ID', defaultVisible: true, isFixed: true, dataType: 'string' },
            { key: 'studentName', label: 'Student Name', defaultVisible: true, dataType: 'string' },
            { key: 'fatherName', label: 'Father Name', defaultVisible: true, dataType: 'string' },
            { key: 'motherName', label: 'Mother Name', defaultVisible: false, dataType: 'string' },
            { key: 'dob', label: 'DOB', defaultVisible: true, dataType: 'date' },
            { key: 'age', label: 'Age', defaultVisible: false, dataType: 'number' },
            { key: 'class', label: 'Class', defaultVisible: true, dataType: 'string' },
            { key: 'section', label: 'Section', defaultVisible: true, dataType: 'string' },
            { key: 'gender', label: 'Gender', defaultVisible: false, dataType: 'string' },
            { key: 'category', label: 'Category', defaultVisible: false, dataType: 'string' },
            { key: 'address', label: 'Address', defaultVisible: false, dataType: 'string' },
            { key: 'phone1', label: 'Phone 1', defaultVisible: true, dataType: 'string' },
            { key: 'phone2', label: 'Phone 2', defaultVisible: true, dataType: 'string' },
            { key: 'aadhaar', label: 'Aadhaar No.', defaultVisible: false, dataType: 'string' },
            { key: 'fatherAadhaar', label: 'Father Aadhaar', defaultVisible: false, dataType: 'string' },
            { key: 'motherAadhaar', label: 'Mother Aadhaar', defaultVisible: false, dataType: 'string' },
            { key: 'eshikshaName', label: 'E-Shiksha Name', defaultVisible: false, dataType: 'string' },
            { key: 'eClass', label: 'E-Class', defaultVisible: false, dataType: 'string' },
            { key: 'eBlock', label: 'E-Block', defaultVisible: false, dataType: 'string' },
            { key: 'udiseName', label: 'UDISE Name', defaultVisible: false, dataType: 'string' },
            { key: 'uClass', label: 'U-Class', defaultVisible: false, dataType: 'string' },
            { key: 'uSection', label: 'U-Section', defaultVisible: false, dataType: 'string' },
            { key: 'penNo', label: 'PEN No.', defaultVisible: false, dataType: 'string' },
            { key: 'aapaarID', label: 'AAPAAR ID', defaultVisible: false, dataType: 'string' },
            { key: 'accHolderName', label: 'Acc. Holder Name', defaultVisible: false, dataType: 'string' },
            { key: 'bankAccNo', label: 'Bank A/c No.', defaultVisible: false, dataType: 'string' },
            { key: 'ifsc', label: 'IFSC', defaultVisible: false, dataType: 'string' },
            { key: 'stateNo', label: 'State No.', defaultVisible: false, dataType: 'string' },
            { key: 'branch', label: 'Branch', defaultVisible: false, dataType: 'string' },
            { key: 'rte', label: 'RTE', defaultVisible: false, dataType: 'string' },
            { key: 'status', label: 'Status', defaultVisible: false, dataType: 'string' },
            { key: 'remark', label: 'Remark', defaultVisible: false, dataType: 'string' },
            { key: 'action', label: 'Action', defaultVisible: true, isFixed: true, isAction: true, dataType: 'none' }
        ];

        let visibleColumns = (function(){
            try{
                const raw = localStorage.getItem('studentListColumns');
                const parsed = raw ? JSON.parse(raw) : null;
                if (Array.isArray(parsed) && parsed.length) return parsed;
            }catch(e){ /* ignore parse errors */ }
            return allColumns.filter(col => col.defaultVisible || col.isFixed).map(c=>c.key);
        })();

        // Utilities
        function formatDBDateForDisplay(dbDate) { return dbDate || 'N/A'; }
        function formatAadhaar(value) {
            if (!value) return 'N/A';
            const s = String(value).replace(/\s|-/g, '').slice(0,12);
            if (s.length < 12) return s;
            return s.replace(/(\d{4})(\d{4})(\d{4})/, '$1-$2-$3');
        }
        function getSafeValue(student, key){
            const val = (student && student[key] !== undefined && student[key] !== null) ? student[key] : '';
            if (typeof val === 'string') return val.trim();
            return String(val);
        }
        function getFilterableColumns() {
            // Include most string columns for easy filtering
            return allColumns.filter(col => 
                !col.isFixed && 
                !col.isAction && 
                col.dataType === 'string' &&
                !['phone1', 'phone2'].includes(col.key)
            );
        }

        function collectUniqueValues(students) {
            const filterable = getFilterableColumns();
            const collectedValues = {};
            
            filterable.forEach(col => {
                const uniqueSet = new Set();
                students.forEach(s => {
                    let value = getSafeValue(s, col.key);
                    if (value) uniqueSet.add(value);
                });
                collectedValues[col.key] = Array.from(uniqueSet)
                    .filter(v => v.toUpperCase() !== 'NULL' && v.toUpperCase() !== 'N/A' && v.trim() !== '')
                    .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            });

            columnUniqueValues = collectedValues;
        }


        // Load data from Firebase (Unchanged)
        async function loadAllStudents(){
            const tableBody = document.getElementById('studentTableBody');
            const currentCols = allColumns.filter(c=>visibleColumns.includes(c.key)).length || 1;
            tableBody.innerHTML = `<tr><td colspan="${currentCols}" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Initializing data...</td></tr>`;

            if (!database){
                tableBody.innerHTML = `<tr><td colspan="${currentCols}" class="loading-row" style="color:var(--danger-color);">Firebase database not initialized!</td></tr>`;
                return;
            }

            try{
                const snapshot = await database.ref(STUDENTS_NODE).once('value');
                const dataObj = snapshot.val() || {};
                allStudentsData = Object.keys(dataObj).map(k=>({ folio: k, ...dataObj[k] }));

                collectUniqueValues(allStudentsData); 
                
                setupColumnToggler();
                populateFilters(allStudentsData);
                processAndRenderStudents(true);
                document.getElementById('totalCount').textContent = allStudentsData.length;
            }catch(err){
                console.error('Error loading student list:', err);
                tableBody.innerHTML = `<tr><td colspan="${currentCols}" class="loading-row" style="color:var(--danger-color);">Error fetching data. Check console.</td></tr>`;
            }
        }

        function populateFilters(students){
            // Standard Class/Section filters (keep for quick access)
            uniqueFilters.classes.clear(); uniqueFilters.sections.clear();
            students.forEach(s=>{
                if (s.class) uniqueFilters.classes.add(getSafeValue(s,'class'));
                if (s.section) uniqueFilters.sections.add(getSafeValue(s,'section'));
            });

            const fillSelect = (selectEl, values, defaultText) =>{
                const cur = selectEl.value;
                selectEl.innerHTML = `<option value="">${defaultText}</option>`;
                Array.from(values).sort().forEach(val=>{
                    if (!val || val.toUpperCase() === 'NULL' || val.toUpperCase() === 'N/A') return;
                    const opt = document.createElement('option'); opt.value = val; opt.textContent = val; selectEl.appendChild(opt);
                });
                if (cur && selectEl.querySelector(`option[value="${cur}"]`)) selectEl.value = cur;
            };

            fillSelect(document.getElementById('classFilter'), uniqueFilters.classes, 'All Classes');
            fillSelect(document.getElementById('sectionFilter'), uniqueFilters.sections, 'All Sections');
        }

        function checkAdvancedFilters(student) {
            for (const filter of currentAdvancedFilters) {
                if (!filter.column || !filter.value) continue;
                
                const studentValue = getSafeValue(student, filter.column);
                const filterValue = filter.value; 

                // Simple Equality Check
                if (studentValue !== filterValue) {
                    return false;
                }
            }
            return true;
        }


        function processAndRenderStudents(resetPage=false){
            const searchKey = document.getElementById('searchFilter').value.toUpperCase().trim();
            const classValue = document.getElementById('classFilter').value;
            const sectionValue = document.getElementById('sectionFilter').value;

            filteredStudentsData = allStudentsData.filter(student=>{
                // 1. Class/Section Filter (Standard Filters)
                const studentClass = getSafeValue(student,'class');
                const studentSection = getSafeValue(student,'section');
                const matchesClass = !classValue || (studentClass===classValue);
                const matchesSection = !sectionValue || (studentSection===sectionValue);
                if (!matchesClass || !matchesSection) return false;
                
                // 2. Advanced Dropdown Filters (Equals Logic)
                if (!checkAdvancedFilters(student)) return false;


                // 3. Search Filter (Keyword Search)
                if (!searchKey) return true;

                const searchFields = [
                    getSafeValue(student,'folio'),
                    getSafeValue(student,'studentName'),
                    getSafeValue(student,'fatherName'),
                    getSafeValue(student,'motherName'),
                    getSafeValue(student,'phone1'),
                    getSafeValue(student,'phone2')
                ].map(x=>x.toUpperCase());

                return searchFields.some(f=> f.includes(searchKey));
            });

            if (resetPage) currentPage = 1;
            renderTable(filteredStudentsData);
        }

        function renderTable(students){
            // ... (Pagination and table rendering logic remains the same)
            const tableBody = document.getElementById('studentTableBody');
            const displayCountSpan = document.getElementById('displayCount');
            const noDataMessage = document.getElementById('noDataMessage');
            const pageInput = document.getElementById('pageNumberInput');


            const startIndex = (currentPage-1)*RECORDS_PER_PAGE;
            const endIndex = startIndex + RECORDS_PER_PAGE;
            const studentsOnPage = students.slice(startIndex, endIndex);

            const totalPages = Math.max(1, Math.ceil(students.length / RECORDS_PER_PAGE));
            
            // Update Pagination Controls
            pageInput.value = currentPage;
            pageInput.max = totalPages;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;


            displayCountSpan.textContent = students.length;

            updateTableHeader();
            const currentColumnDefs = allColumns.filter(col => visibleColumns.includes(col.key));
            const colspan = currentColumnDefs.length || 1;

            tableBody.innerHTML = '';

            if (students.length === 0){
                noDataMessage.style.display = 'block';
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="loading-row">No records found matching the current filters.</td></tr>`;
                return;
            }

            noDataMessage.style.display = 'none';

            studentsOnPage.forEach(student=>{
                const row = tableBody.insertRow();
                currentColumnDefs.forEach(columnDef=>{
                    const key = columnDef.key;
                    const cell = row.insertCell();
                    if (key === 'action'){
                        const editButton = document.createElement('button');
                        editButton.className = 'action-btn btn-edit';
                        editButton.innerHTML = '<i class="fas fa-pen-to-square" aria-hidden="true"></i> Edit';
                        editButton.type = 'button';
                        editButton.addEventListener('click', ()=>{
                            const folioId = student.folio || '';
                            if (folioId){ window.location.href = `Student.html?searchKey=${encodeURIComponent(folioId)}`; }
                            else alert('Error: Folio ID is missing for this record.');
                        });
                        cell.appendChild(editButton);
                    } else {
                        let value = getSafeValue(student, key);
                        if (key === 'dob') value = formatDBDateForDisplay(value);
                        else if (key.toLowerCase().includes('aadhaar')) value = formatAadhaar(value);

                        if ((key === 'phone1' || key === 'phone2') && /\d{5,}/.test(value)){
                            const link = document.createElement('a');
                            link.href = `tel:${value.replace(/[^0-9]/g,'')}`;
                            link.textContent = value;
                            link.rel = 'nofollow';
                            cell.appendChild(link);
                        } else {
                            cell.textContent = value || 'N/A';
                        }
                    }
                });
            });

            document.getElementById('studentTable').scrollLeft = 0;
        }

        // --- (Column Toggler, Pagination Helpers are omitted for brevity, assumed to be unchanged) ---
        function updateTableHeader(){
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const currentColumnDefs = allColumns.filter(col => visibleColumns.includes(col.key));
            tableHeaderRow.innerHTML = '';
            currentColumnDefs.forEach(columnDef => {
                const th = document.createElement('th');
                th.textContent = columnDef.label;
                tableHeaderRow.appendChild(th);
            });
        }
        function setupColumnToggler(){
            const contentDiv = document.getElementById('columnTogglerContent');
            const toggleButton = document.getElementById('toggleColumnsBtn');
            contentDiv.innerHTML = '';

            allColumns.forEach(column=>{
                if (column.isFixed) return;
                const isChecked = visibleColumns.includes(column.key);
                const label = document.createElement('label');
                label.setAttribute('role','menuitemcheckbox');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = column.key; checkbox.checked = isChecked;
                checkbox.addEventListener('change', updateVisibleColumns);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(column.label));
                contentDiv.appendChild(label);
            });

            toggleButton.onclick = (e)=>{
                e.stopPropagation();
                const isOpen = contentDiv.style.display === 'block';
                contentDiv.style.display = isOpen ? 'none' : 'block';
                toggleButton.setAttribute('aria-expanded', String(!isOpen));
                contentDiv.setAttribute('aria-hidden', String(isOpen));
            };
            document.addEventListener('click', (event)=>{
                if (!document.querySelector('.column-toggler').contains(event.target)){
                    contentDiv.style.display = 'none';
                    document.getElementById('toggleColumnsBtn').setAttribute('aria-expanded','false');
                    contentDiv.setAttribute('aria-hidden','true');
                }
            });
        }

        function updateVisibleColumns(){
            const checkboxes = document.querySelectorAll('#columnTogglerContent input[type="checkbox"]');
            const newVisible = [];
            checkboxes.forEach(cb=>{ if (cb.checked) newVisible.push(cb.value); });
            const fixedKeys = allColumns.filter(c=>c.isFixed).map(c=>c.key);
            visibleColumns = allColumns.filter(c => fixedKeys.includes(c.key) || newVisible.includes(c.key)).map(c=>c.key);
            try{ localStorage.setItem('studentListColumns', JSON.stringify(visibleColumns)); }catch(e){ console.warn('Could not save columns to localStorage', e); }
            processAndRenderStudents(false);
        }

        function goToPage(pageNumber){
            const totalPages = Math.ceil(filteredStudentsData.length / RECORDS_PER_PAGE) || 1;
            let targetPage = parseInt(pageNumber);
            if (isNaN(targetPage) || targetPage < 1) targetPage = 1;
            if (targetPage > totalPages) targetPage = totalPages;

            if (targetPage !== currentPage){ 
                currentPage = targetPage; 
                renderTable(filteredStudentsData); 
                document.getElementById('studentTable').scrollIntoView({ behavior: 'smooth' }); 
            }
        }
        
        function handlePageInput(){
            const pageInput = document.getElementById('pageNumberInput');
            const inputVal = parseInt(pageInput.value);
            
            if (!isNaN(inputVal) && inputVal >= 1) {
                goToPage(inputVal);
            } else {
                pageInput.value = currentPage;
            }
        }

        // Global Download function (Downloads data based on ALL currently applied filters)
        function downloadExcel(dataToDownload, fileNameSuffix = 'All_Filters'){
            if (!dataToDownload.length){ alert('No data to download!'); return; }

            const columnsForDownload = allColumns.filter(col => !col.isAction);
            const header = columnsForDownload.map(col => `"${col.label.replace(/"/g,'""')}"`).join(',');

            const rows = dataToDownload.map(student => {
                const values = columnsForDownload.map(col => {
                    let value = getSafeValue(student, col.key);
                    if (col.key === 'dob') value = formatDBDateForDisplay(value);
                    else if (col.key.toLowerCase().includes('aadhaar')) value = formatAadhaar(value);
                    return `"${String(value).replace(/"/g,'""')}"`;
                });
                return values.join(',');
            });

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + header + "\n" + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `Student_Data_Export_${fileNameSuffix}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        /* ========================================================= */
        /* SIMPLIFIED ADVANCED FILTER LOGIC */
        /* ========================================================= */

        const advancedFilterModal = document.getElementById('advancedFilterModal');
        const filterCriteriaDiv = document.getElementById('filterCriteria');

        function populateValueSelect(columnKey, valueSelect, currentValue = '') {
            valueSelect.innerHTML = '<option value="">Select Value</option>';
            if (columnKey && columnUniqueValues[columnKey]) {
                columnUniqueValues[columnKey].forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    if (currentValue === val) option.selected = true;
                    valueSelect.appendChild(option);
                });
            }
        }

        function createFilterRow(filter = { column: '', value: '' }) {
            const row = document.createElement('div');
            row.className = 'filter-row';
            row.dataset.id = Date.now() + Math.random().toString(36).substring(2); 

            const filterableColumns = getFilterableColumns();

            // 1. Column Select
            const columnSelect = document.createElement('select');
            columnSelect.className = 'filter-column';
            columnSelect.innerHTML = '<option value="">Select Column</option>';
            filterableColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.key;
                option.textContent = col.label;
                if (filter.column === col.key) option.selected = true;
                columnSelect.appendChild(option);
            });
            row.appendChild(columnSelect);

            // 2. Value Select (Dropdown)
            const valueSelect = document.createElement('select');
            valueSelect.className = 'filter-value';
            valueSelect.innerHTML = '<option value="">Select Value</option>';
            populateValueSelect(filter.column, valueSelect, filter.value);
            row.appendChild(valueSelect);


            // 3. Delete Button
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-filter-btn';
            deleteButton.innerHTML = '<i class="fas fa-times"></i>';
            deleteButton.title = 'Remove Filter';
            deleteButton.onclick = () => row.remove();
            row.appendChild(deleteButton);
            
            columnSelect.addEventListener('change', () => {
                const selectedColKey = columnSelect.value;
                populateValueSelect(selectedColKey, valueSelect);
            });

            return row;
        }

        function renderAdvancedFilters() {
            filterCriteriaDiv.innerHTML = '';
            if (currentAdvancedFilters.length === 0) {
                currentAdvancedFilters.push({ column: '', value: '' }); 
            }

            currentAdvancedFilters.forEach(filter => {
                filterCriteriaDiv.appendChild(createFilterRow(filter));
            });
        }

        function saveAdvancedFilters() {
             const rows = document.querySelectorAll('.filter-row');
            const newFilters = [];

            rows.forEach(row => {
                const column = row.querySelector('.filter-column').value;
                const value = row.querySelector('.filter-value').value;

                // Only save filters where both column and value are selected
                if (column && value) {
                    newFilters.push({ column, value });
                }
            });
            currentAdvancedFilters = newFilters;
            return newFilters;
        }

        function saveAndApplyAdvancedFilters() {
            saveAdvancedFilters();
            advancedFilterModal.style.display = 'none';
            // Trigger main data processing to apply new filters
            processAndRenderStudents(true);
        }

        // NEW: Function to apply filters and trigger download
        function downloadFilteredExcel() {
            // First, save the filters currently selected in the modal (but don't hide the modal)
            const tempFilters = saveAdvancedFilters();
            
            if (tempFilters.length === 0) {
                 alert('Please select at least one filter criterion (Column and Value) before downloading.');
                 return;
            }

            // Temporarily apply the filters to find out which data should be downloaded
            // Note: This relies on 'processAndRenderStudents' calculating 'filteredStudentsData'
            // For a safer approach, we run a temporary filter using the standard filters + advanced filters
            
            const searchKey = document.getElementById('searchFilter').value.toUpperCase().trim();
            const classValue = document.getElementById('classFilter').value;
            const sectionValue = document.getElementById('sectionFilter').value;

            const dataToDownload = allStudentsData.filter(student => {
                // Standard Filters
                const studentClass = getSafeValue(student, 'class');
                const studentSection = getSafeValue(student, 'section');
                const matchesClass = !classValue || (studentClass === classValue);
                const matchesSection = !sectionValue || (studentSection === sectionValue);
                if (!matchesClass || !matchesSection) return false;

                // Advanced Filters (using the temporary filters from the modal)
                for (const filter of tempFilters) {
                    if (getSafeValue(student, filter.column) !== filter.value) return false;
                }

                // Search Filter (Keyword Search)
                if (!searchKey) return true;
                const searchFields = [
                    getSafeValue(student,'folio'), getSafeValue(student,'studentName'), getSafeValue(student,'fatherName'), 
                    getSafeValue(student,'motherName'), getSafeValue(student,'phone1'), getSafeValue(student,'phone2')
                ].map(x=>x.toUpperCase());
                return searchFields.some(f=> f.includes(searchKey));
            });

            if (dataToDownload.length > 0) {
                downloadExcel(dataToDownload, 'Advanced_Filter_Export');
            } else {
                alert('No records match the selected advanced filters. Nothing to download.');
            }
            
            // Note: The modal remains open, and the main data on the dashboard is NOT re-rendered/changed 
            // until the user clicks "Apply Filters".
        }

        
        function initAdvancedFilterModal(){
            document.getElementById('openAdvancedFilterBtn').onclick = () => {
                renderAdvancedFilters();
                advancedFilterModal.style.display = 'block';
            };

            document.getElementById('closeAdvancedFilterBtn').onclick = () => {
                advancedFilterModal.style.display = 'none';
            };

            window.onclick = (event) => {
                if (event.target == advancedFilterModal) {
                    advancedFilterModal.style.display = 'none';
                }
            };
            
            document.getElementById('addFilterBtn').onclick = () => {
                filterCriteriaDiv.appendChild(createFilterRow());
            };

            document.getElementById('applyFiltersBtn').onclick = saveAndApplyAdvancedFilters;
            // NEW: Wire up the Download Filtered button
            document.getElementById('downloadFilteredBtn').onclick = downloadFilteredExcel; 
        }

        // Initialization and Event wiring
        document.addEventListener('DOMContentLoaded', ()=>{
            loadAllStudents();

            const classFilter = document.getElementById('classFilter');
            const sectionFilter = document.getElementById('sectionFilter');
            const searchFilter = document.getElementById('searchFilter');
            const resetFiltersButton = document.getElementById('resetFilters');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const downloadExcelBtn = document.getElementById('downloadExcelBtn');
            const pageNumberInput = document.getElementById('pageNumberInput'); 

            classFilter.addEventListener('change', ()=> processAndRenderStudents(true));
            sectionFilter.addEventListener('change', ()=> processAndRenderStudents(true));

            let searchTimeout;
            searchFilter.addEventListener('input', ()=>{
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(()=>{ processAndRenderStudents(true); }, 300);
            });

            resetFiltersButton.addEventListener('click', ()=>{
                classFilter.value = '';
                sectionFilter.value = '';
                searchFilter.value = '';
                currentAdvancedFilters = []; 
                processAndRenderStudents(true);
            });

            prevPageBtn.addEventListener('click', ()=> goToPage(currentPage - 1));
            nextPageBtn.addEventListener('click', ()=> goToPage(currentPage + 1));
            pageNumberInput.addEventListener('change', handlePageInput);

            // Global Download button: downloads whatever is currently filtered in the main view
            downloadExcelBtn.addEventListener('click', () => downloadExcel(filteredStudentsData, 'Current_View'));

            initAdvancedFilterModal();

            document.addEventListener('keydown', (e)=>{
                if (e.key === 'Escape'){
                    const contentDiv = document.getElementById('columnTogglerContent');
                    if (contentDiv.style.display === 'block'){
                        contentDiv.style.display = 'none';
                        document.getElementById('toggleColumnsBtn').setAttribute('aria-expanded','false');
                        contentDiv.setAttribute('aria-hidden','true');
                    }
                    if (advancedFilterModal.style.display === 'block'){
                        advancedFilterModal.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html>