name: Production Multi-Module Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "gh-pages-deploy"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Deploy Directory (Safe Copy)
        run: |
          mkdir -p deploy_build
          rsync -av --exclude='.git' . deploy_build/

      - name: Verify index.html Exists
        working-directory: deploy_build
        run: |
          FILE="index.html"

          if [ ! -f "$FILE" ]; then
            echo "‚ùå ERROR: index.html not found!"
            echo "Available root files:"
            ls -R . || true
            exit 1
          fi

      - name: Inject Firebase Secrets into index.html
        working-directory: deploy_build
        run: |
          FILE="index.html"

          sed -i \
            -e "s#VITE_FIREBASE_API_KEY#${{ secrets.VITE_FIREBASE_API_KEY }}#g" \
            -e "s#VITE_FIREBASE_AUTH_DOMAIN#${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}#g" \
            -e "s#VITE_FIREBASE_DB_URL#${{ secrets.VITE_FIREBASE_DB_URL }}#g" \
            -e "s#VITE_FIREBASE_PROJECT_ID#${{ secrets.VITE_FIREBASE_PROJECT_ID }}#g" \
            -e "s#VITE_FIREBASE_STORAGE_BUCKET#${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}#g" \
            -e "s#VITE_FIREBASE_MESSAGING_ID#${{ secrets.VITE_FIREBASE_MESSAGING_ID }}#g" \
            -e "s#VITE_FIREBASE_APP_ID#${{ secrets.VITE_FIREBASE_APP_ID }}#g" \
            "$FILE"

      - name: Production Deployment to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy_build
          branch: gh-pages
          clean: true
